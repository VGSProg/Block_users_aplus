define("block_users_aplus/base",["core/ajax","core/config","core/templates","core/notification"],(function(Ajax, Config, Templates, Notification){
    var fetchMany = Ajax.call;

    var render_block = (template, data) => {
        Templates.renderForPromise(template, data).then(({html, js}) => {
            document.getElementById('block_users_aplus_box_content').innerHTML = html;
        }).catch((error) => {console.log(error);});     
    };

    var load_display_set = function(obj, display_val, timeout){
        if(timeout === 0){
            obj.style.display = display_val;
            return;
        }
        setTimeout(function(){
            obj.style.display = display_val;
        },timeout);
    };
    var load_start = function(){
        var box_load = document.getElementById('block_users_aplus_box_load');
        box_load.style.opacity = 0.7;
        load_display_set(box_load, 'table', 0);
    };
    var load_end = function(){
        var box_load = document.getElementById('block_users_aplus_box_load');
        box_load.style.opacity = 0.0;
        load_display_set(box_load, 'none', 1000);
    };

    var query_user_info = function(user_id) {
        var promise = Ajax.call([{
            methodname: 'block_users_aplus_user_info',
            args: {
                'user_id': user_id
            }
        }])[0];

        promise.fail(Notification.exception);

        return promise;
    };

    var query_users_list = function(user_id) {
        var promise = Ajax.call([{
            methodname: 'block_users_aplus_users_list',
            args: {
                'limit': 0,
                'offset': 0
            }
        }])[0];

        promise.fail(Notification.exception);

        return promise;
    };

    var query_user_add_grade = function(user_id, grade) {
        var promise = Ajax.call([{
            methodname: 'block_users_aplus_user_add_grade',
            args: {
                'user_id': user_id,
                'grade': grade
            }
        }])[0];

        promise.fail(Notification.exception);

        return promise;
    };


    var user_info_data_cache = null;

    window.block_users_aplus_user_info = function(userId){
        load_start();
        var response = query_user_info(userId).then(data => {
            user_info_data_cache = data;
            render_block('block_users_aplus/user_info',data);
            load_end();
        }).catch(Notification.exception);
    };

    window.block_users_aplus_go_home = function(){
        load_start();
        var response = query_users_list(0).then(data => {
            render_block('block_users_aplus/users_list',data);
            load_end();
        }).catch(Notification.exception);
    };

    window.block_users_aplus_add_user_grade = function(){
        if(user_info_data_cache === null){
            return;
        }
        load_start();
        render_block('block_users_aplus/user_add_grade',user_info_data_cache);
        load_end();
    };
    window.block_users_aplus_add_user_grade_set = function(grade){
        load_start();
        var response = query_user_add_grade(user_info_data_cache.user.id, grade).then(data => {
            console.log(data);
            //check data
            //
            window.block_users_aplus_user_info(user_info_data_cache.user.id);
            load_end();
        }).catch(Notification.exception);
    };


    return {
        init:function(){
        },
    }
}));
